<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ü¶ç Gorilla Tag VR/PC</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: #000;
      color: white;
      font-family: monospace;
    }
    #vr-button {
      position: absolute;
      top: 20px;
      left: 20px;
      padding: 10px 20px;
      background: #111;
      border: 2px solid #0f0;
      color: #0f0;
      font-weight: bold;
      border-radius: 12px;
      cursor: pointer;
      z-index: 10;
    }
    canvas {
      display: block;
    }
  </style>
</head>
<body>
  <button id="vr-button">Enter VR</button>
  <script type="module">
    import * as THREE from "https://cdn.skypack.dev/three@0.158.0";
    import { XRControllerModelFactory } from "https://cdn.skypack.dev/three/examples/jsm/webxr/XRControllerModelFactory.js";

    // Basic Setup
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x111111);

    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.01, 1000);
    camera.position.y = 1.6;

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.xr.enabled = true;
    document.body.appendChild(renderer.domElement);

    // Lights
    const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444);
    hemiLight.position.set(0, 20, 0);
    scene.add(hemiLight);

    const dirLight = new THREE.DirectionalLight(0xffffff, 0.5);
    dirLight.position.set(5, 10, 7.5);
    scene.add(dirLight);

    // Floor
    const floor = new THREE.Mesh(
      new THREE.PlaneGeometry(200, 200),
      new THREE.MeshStandardMaterial({ color: 0x228b22 })
    );
    floor.rotation.x = -Math.PI / 2;
    floor.receiveShadow = true;
    scene.add(floor);

    // Forest
    const treeMaterial = new THREE.MeshStandardMaterial({ color: 0x8B4513 });
    const treeGeometry = new THREE.CylinderGeometry(0.5, 1, 5, 6);
    for (let i = 0; i < 30; i++) {
      const tree = new THREE.Mesh(treeGeometry, treeMaterial);
      tree.position.set(Math.random() * 80 - 40, 2.5, Math.random() * 80 - 40);
      scene.add(tree);
    }

    // Controller / VR Setup
    const controllerModelFactory = new XRControllerModelFactory();
    const hands = [];

    function setupHand(index) {
      const controller = renderer.xr.getController(index);
      scene.add(controller);

      const grip = renderer.xr.getControllerGrip(index);
      grip.add(controllerModelFactory.createControllerModel(grip));
      scene.add(grip);

      hands.push({ controller, prev: new THREE.Vector3() });
    }

    setupHand(0);
    setupHand(1);

    const velocity = new THREE.Vector3();
    const handSpeed = 0.05;

    function updateVRMovement() {
      hands.forEach(({ controller, prev }) => {
        const current = new THREE.Vector3();
        controller.getWorldPosition(current);
        const delta = current.clone().sub(prev);
        velocity.add(delta.multiplyScalar(-handSpeed));
        prev.copy(current);
      });

      camera.position.add(velocity);
      velocity.multiplyScalar(0.85); // Friction
    }

    // --- Desktop Controls (PC Mode)
    let moveForward = false, moveBackward = false, moveLeft = false, moveRight = false;
    const pcVelocity = new THREE.Vector3();
    const keys = {};

    document.addEventListener('keydown', e => keys[e.code] = true);
    document.addEventListener('keyup', e => keys[e.code] = false);

    const pcSpeed = 0.1;

    const pitch = new THREE.Object3D();
    const yaw = new THREE.Object3D();
    yaw.add(pitch);
    pitch.add(camera);

    scene.add(yaw);

    let mouseDown = false;
    document.addEventListener('mousedown', () => { mouseDown = true; });
    document.addEventListener('mouseup', () => { mouseDown = false; });

    document.addEventListener('mousemove', e => {
      if (!mouseDown) return;
      yaw.rotation.y -= e.movementX * 0.002;
      pitch.rotation.x -= e.movementY * 0.002;
      pitch.rotation.x = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, pitch.rotation.x));
    });

    function updatePCMovement() {
      const dir = new THREE.Vector3();
      if (keys["KeyW"]) dir.z -= 1;
      if (keys["KeyS"]) dir.z += 1;
      if (keys["KeyA"]) dir.x -= 1;
      if (keys["KeyD"]) dir.x += 1;
      dir.normalize().applyEuler(yaw.rotation);
      pcVelocity.add(dir.multiplyScalar(pcSpeed));
      yaw.position.add(pcVelocity);
      pcVelocity.multiplyScalar(0.8);
    }

    // Animate
    renderer.setAnimationLoop(() => {
      if (renderer.xr.isPresenting) {
        updateVRMovement();
        renderer.render(scene, camera);
      } else {
        updatePCMovement();
        renderer.render(scene, camera);
      }
    });

    // Resize
    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    // VR Button
    const vrButton = document.getElementById("vr-button");
    vrButton.addEventListener("click", () => {
      navigator.xr?.isSessionSupported?.('immersive-vr').then((supported) => {
        if (supported) {
          navigator.xr.requestSession("immersive-vr", {
            optionalFeatures: ["local-floor", "bounded-floor", "hand-tracking"]
          }).then(session => renderer.xr.setSession(session));
        } else {
          alert("WebXR not supported üò≠");
        }
      }).catch(err => alert("WebXR error: " + err));
    });
  </script>
</body>
</html>
